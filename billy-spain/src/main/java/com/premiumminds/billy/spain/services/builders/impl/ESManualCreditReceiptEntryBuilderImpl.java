  package       com . premiumminds . billy . spain . services . builders . impl ;   import      com . premiumminds . billy . core . exceptions . BillyValidationException ;  import      com . premiumminds . billy . core . exceptions . DuplicateCreditNoteException ;  import      com . premiumminds . billy . core . services . UID ;  import         com . premiumminds . billy . core . services . entities . documents . GenericInvoice . CreditOrDebit ;  import      com . premiumminds . billy . core . util . BillyValidator ;  import      com . premiumminds . billy . core . util . NotOnUpdate ;  import       com . premiumminds . billy . spain . persistence . dao . DAOESCreditReceiptEntry ;  import       com . premiumminds . billy . spain . persistence . dao . DAOESProduct ;  import       com . premiumminds . billy . spain . persistence . dao . DAOESReceipt ;  import       com . premiumminds . billy . spain . persistence . dao . DAOESRegionContext ;  import       com . premiumminds . billy . spain . persistence . dao . DAOESTax ;  import       com . premiumminds . billy . spain . persistence . entities . ESCreditReceiptEntryEntity ;  import       com . premiumminds . billy . spain . persistence . entities . ESReceiptEntity ;  import       com . premiumminds . billy . spain . services . builders . ESManualCreditReceiptEntryBuilder ;  import       com . premiumminds . billy . spain . services . entities . ESCreditReceiptEntry ;   public class ESManualCreditReceiptEntryBuilderImpl  <  TBuilder  extends  ESManualCreditReceiptEntryBuilderImpl  < TBuilder , TEntry > ,  TEntry  extends ESCreditReceiptEntry >  extends  ESManualEntryBuilderImpl  < TBuilder , TEntry , DAOESCreditReceiptEntry , DAOESReceipt >  implements   ESManualCreditReceiptEntryBuilder  < TBuilder , TEntry >  {   public ESManualCreditReceiptEntryBuilderImpl  (  DAOESCreditReceiptEntry daoESCreditReceiptEntry ,  DAOESReceipt daoESReceipt ,  DAOESTax daoESTax ,  DAOESProduct daoESProduct ,  DAOESRegionContext daoESRegionContext )  {  super  ( daoESCreditReceiptEntry , daoESReceipt , daoESTax , daoESProduct , daoESRegionContext ) ; }    @ NotOnUpdate public  @ Override TBuilder setReferenceUID  (  UID referenceUID )  {   BillyValidator . notNull  ( referenceUID ,   ESCreditReceiptEntryBuilderImpl . LOCALIZER . getString  ( "field.invoice_reference" ) ) ;  ESReceiptEntity  i =   this . daoInvoice . get  ( referenceUID ) ;   BillyValidator . found  ( i ,   ESGenericInvoiceBuilderImpl . LOCALIZER . getString  ( "field.invoice_reference" ) ) ;    this . getTypeInstance  ( ) . setReference  ( i ) ;  return  this . getBuilder  ( ) ; }    @ NotOnUpdate public  @ Override TBuilder setReason  (  String reason )  {   BillyValidator . notBlank  ( reason ,   ESCreditNoteEntryBuilderImpl . LOCALIZER . getString  ( "field.reason" ) ) ;    this . getTypeInstance  ( ) . setReason  ( reason ) ;  return  this . getBuilder  ( ) ; }    @ Override protected ESCreditReceiptEntryEntity getTypeInstance  ( )  {  return  ( ESCreditReceiptEntryEntity )  super . getTypeInstance  ( ) ; }    @ Override protected void validateInstance  ( )  throws BillyValidationException  {    this . getTypeInstance  ( ) . setCreditOrDebit  (  CreditOrDebit . DEBIT ) ;   super . validateInstance  ( ) ;  ESCreditReceiptEntryEntity  cn =  this . getTypeInstance  ( ) ;   BillyValidator . mandatory  (  cn . getQuantity  ( ) ,   ESGenericInvoiceEntryBuilderImpl . LOCALIZER . getString  ( "field.quantity" ) ) ;   BillyValidator . mandatory  (  cn . getUnitOfMeasure  ( ) ,   ESGenericInvoiceEntryBuilderImpl . LOCALIZER . getString  ( "field.unit" ) ) ;   BillyValidator . mandatory  (  cn . getProduct  ( ) ,   ESGenericInvoiceEntryBuilderImpl . LOCALIZER . getString  ( "field.product" ) ) ;   BillyValidator . notEmpty  (  cn . getTaxes  ( ) ,   ESGenericInvoiceEntryBuilderImpl . LOCALIZER . getString  ( "field.tax" ) ) ;   BillyValidator . mandatory  (  cn . getTaxAmount  ( ) ,   ESGenericInvoiceEntryBuilderImpl . LOCALIZER . getString  ( "field.tax" ) ) ;   BillyValidator . mandatory  (  cn . getTaxPointDate  ( ) ,   ESGenericInvoiceEntryBuilderImpl . LOCALIZER . getString  ( "field.tax_point_date" ) ) ;   BillyValidator . mandatory  (  cn . getReference  ( ) ,   ESCreditNoteEntryBuilderImpl . LOCALIZER . getString  ( "field.invoice_reference" ) ) ;   BillyValidator . mandatory  (  cn . getReason  ( ) ,   ESCreditNoteEntryBuilderImpl . LOCALIZER . getString  ( "field.reason" ) ) ;   this . ValidateESCreditReceiptEntry  ( cn ) ; }   private void ValidateESCreditReceiptEntry  (  ESCreditReceiptEntryEntity cn )  {  if  (    this . daoEntry . checkCreditReceipt  (  cn . getReference  ( ) ) != null )  {  throw  new DuplicateCreditNoteException  ( ) ; } } }