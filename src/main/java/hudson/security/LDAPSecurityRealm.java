  package  hudson . security ;   import      edu . umd . cs . findbugs . annotations . SuppressFBWarnings ;  import   groovy . lang . Binding ;  import  hudson . DescriptorExtensionList ;  import  hudson . Extension ;  import static   hudson . Util . fixEmpty ;  import static   hudson . Util . fixEmptyAndTrim ;  import static   hudson . Util . fixNull ;  import  hudson . Util ;  import   hudson . model . AbstractDescribableImpl ;  import   hudson . model . Descriptor ;  import   hudson . model . User ;  import   hudson . tasks . MailAddressResolver ;  import   hudson . tasks . Mailer ;  import    hudson . tasks . Mailer . UserProperty ;  import   hudson . util . FormValidation ;  import   hudson . util . ListBoxModel ;  import   hudson . util . Scrambler ;  import   hudson . util . Secret ;  import    hudson . util . spring . BeanBuilder ;  import   java . io . File ;  import   java . io . FileInputStream ;  import   java . io . FileNotFoundException ;  import   java . io . IOException ;  import   java . io . Serializable ;  import   java . net . InetAddress ;  import   java . net . Socket ;  import   java . net . URISyntaxException ;  import   java . net . UnknownHostException ;  import   java . net . URI ;  import  java . util .  * ;  import    java . util . concurrent . TimeUnit ;  import    java . util . logging . Level ;  import    java . util . logging . Logger ;  import    java . util . regex . Matcher ;  import    java . util . regex . Pattern ;  import   javax . annotation . CheckForNull ;  import   javax . annotation . Nonnull ;  import   javax . naming . Context ;  import   javax . naming . NamingException ;  import    javax . naming . directory . Attribute ;  import    javax . naming . directory . Attributes ;  import    javax . naming . directory . BasicAttributes ;  import    javax . naming . directory . DirContext ;  import    javax . naming . directory . InitialDirContext ;  import    javax . naming . ldap . Control ;  import   jenkins . model . IdStrategy ;  import   jenkins . model . Jenkins ;  import     jenkins . security . plugins . ldap . FromGroupSearchLDAPGroupMembershipStrategy ;  import     jenkins . security . plugins . ldap . LDAPConfiguration ;  import     jenkins . security . plugins . ldap . LDAPGroupMembershipStrategy ;  import  org . acegisecurity .  * ;  import    org . acegisecurity . ldap . InitialDirContextFactory ;  import    org . acegisecurity . ldap . LdapDataAccessException ;  import    org . acegisecurity . ldap . LdapTemplate ;  import    org . acegisecurity . ldap . LdapUserSearch ;  import     org . acegisecurity . ldap . search . FilterBasedLdapUserSearch ;  import    org . acegisecurity . providers . UsernamePasswordAuthenticationToken ;  import     org . acegisecurity . providers . ldap . LdapAuthoritiesPopulator ;  import      org . acegisecurity . providers . ldap . populator . DefaultLdapAuthoritiesPopulator ;  import    org . acegisecurity . userdetails . UserDetails ;  import    org . acegisecurity . userdetails . UserDetailsService ;  import    org . acegisecurity . userdetails . UsernameNotFoundException ;  import     org . acegisecurity . userdetails . ldap . LdapUserDetails ;  import     org . acegisecurity . userdetails . ldap . LdapUserDetailsImpl ;  import      org . apache . commons . collections . map . LRUMap ;  import      org . apache . commons . io . input . AutoCloseInputStream ;  import     org . apache . commons . lang . StringUtils ;  import    org . kohsuke . accmod . Restricted ;  import     org . kohsuke . accmod . restrictions . DoNotUse ;  import     org . kohsuke . accmod . restrictions . NoExternalUse ;  import    org . kohsuke . stapler . DataBoundConstructor ;  import    org . kohsuke . stapler . QueryParameter ;  import    org . springframework . dao . DataAccessException ;  import     org . springframework . web . context . WebApplicationContext ;   public class LDAPSecurityRealm  extends AbstractPasswordBasedSecurityRealm  {   private static final boolean  FORCE_USERNAME_LOWERCASE =  Boolean . getBoolean  (    LDAPSecurityRealm . class . getName  ( ) + ".forceUsernameLowercase" ) ;   private static final boolean  FORCE_GROUPNAME_LOWERCASE =  Boolean . getBoolean  (    LDAPSecurityRealm . class . getName  ( ) + ".forceGroupnameLowercase" ) ;    @ SuppressFBWarnings  (  value = "UUF_UNUSED_PUBLIC_OR_PROTECTED_FIELD" ,  justification = "This public field is exposed to the plugin's API" )  @ Deprecated  @ Restricted  (  NoExternalUse . class ) public transient String  server ;    @ SuppressFBWarnings  (  value = "UUF_UNUSED_PUBLIC_OR_PROTECTED_FIELD" ,  justification = "This public field is exposed to the plugin's API" )  @ Deprecated  @ Restricted  (  NoExternalUse . class ) public transient String  rootDN ;    @ SuppressFBWarnings  (  value = "UUF_UNUSED_PUBLIC_OR_PROTECTED_FIELD" ,  justification = "This public field is exposed to the plugin's API" )  @ Deprecated  @ Restricted  (  NoExternalUse . class ) public transient boolean  inhibitInferRootDN ;    @ SuppressFBWarnings  (  value = "UUF_UNUSED_PUBLIC_OR_PROTECTED_FIELD" ,  justification = "This public field is exposed to the plugin's API" )  @ Deprecated  @ Restricted  (  NoExternalUse . class ) public transient String  userSearchBase ;    @ SuppressFBWarnings  (  value = "UUF_UNUSED_PUBLIC_OR_PROTECTED_FIELD" ,  justification = "This public field is exposed to the plugin's API" )  @ Deprecated  @ Restricted  (  NoExternalUse . class ) public transient String  userSearch ;    @ SuppressFBWarnings  (  value = "UUF_UNUSED_PUBLIC_OR_PROTECTED_FIELD" ,  justification = "This public field is exposed to the plugin's API" )  @ Deprecated  @ Restricted  (  NoExternalUse . class ) public transient String  groupSearchBase ;    @ SuppressFBWarnings  (  value = "UUF_UNUSED_PUBLIC_OR_PROTECTED_FIELD" ,  justification = "This public field is exposed to the plugin's API" )  @ Deprecated  @ Restricted  (  NoExternalUse . class ) public transient String  groupSearchFilter ;    @ Deprecated  @ Restricted  (  NoExternalUse . class )  @ SuppressFBWarnings  (  value = "UUF_UNUSED_PUBLIC_OR_PROTECTED_FIELD" ,  justification = "This public field is exposed to the plugin's API" ) public transient String  groupMembershipFilter ;    @ SuppressFBWarnings  (  value = "UUF_UNUSED_PUBLIC_OR_PROTECTED_FIELD" ,  justification = "This public field is exposed to the plugin's API" )  @ Deprecated  @ Restricted  (  NoExternalUse . class ) public transient LDAPGroupMembershipStrategy  groupMembershipStrategy ;    @ SuppressFBWarnings  (  value = "UUF_UNUSED_PUBLIC_OR_PROTECTED_FIELD" ,  justification = "This public field is exposed to the plugin's API" )  @ Deprecated  @ Restricted  (  NoExternalUse . class ) public transient String  managerDN ;    @ Deprecated  @ Restricted  (  NoExternalUse . class )  @ SuppressFBWarnings  (  value = "UUF_UNUSED_PUBLIC_OR_PROTECTED_FIELD" ,  justification = "This public field is exposed to the plugin's API" ) private transient String  managerPassword ;    @ Deprecated  @ Restricted  (  NoExternalUse . class ) private transient Secret  managerPasswordSecret ;    @ SuppressFBWarnings  (  value = "UUF_UNUSED_PUBLIC_OR_PROTECTED_FIELD" ,  justification = "This public field is exposed to the plugin's API" ) public final boolean  disableMailAddressResolver ;   private  List  < LDAPConfiguration >  configurations ;   private final CacheConfiguration  cache ;   private transient  Map  < String ,  CacheEntry  < LdapUserDetails > >  userDetailsCache = null ;   private transient  Map  < String ,  CacheEntry  <  Set  < String > > >  groupDetailsCache = null ;    @ Deprecated  @ Restricted  (  NoExternalUse . class ) private transient  Map  < String , String >  extraEnvVars ;    @ Deprecated  @ Restricted  (  NoExternalUse . class ) private transient String  displayNameAttributeName ;    @ Deprecated  @ Restricted  (  NoExternalUse . class ) private transient String  mailAddressAttributeName ;   private final IdStrategy  userIdStrategy ;   private final IdStrategy  groupIdStrategy ;    @ Deprecated public LDAPSecurityRealm  (  String server ,  String rootDN ,  String userSearchBase ,  String userSearch ,  String groupSearchBase ,  String managerDN ,  String managerPassword ,  boolean inhibitInferRootDN )  {  this  ( server , rootDN , userSearchBase , userSearch , groupSearchBase , managerDN , managerPassword , inhibitInferRootDN , false ) ; }    @ Deprecated public LDAPSecurityRealm  (  String server ,  String rootDN ,  String userSearchBase ,  String userSearch ,  String groupSearchBase ,  String managerDN ,  String managerPassword ,  boolean inhibitInferRootDN ,  boolean disableMailAddressResolver )  {  this  ( server , rootDN , userSearchBase , userSearch , groupSearchBase , managerDN , managerPassword , inhibitInferRootDN , disableMailAddressResolver , null ) ; }    @ Deprecated public LDAPSecurityRealm  (  String server ,  String rootDN ,  String userSearchBase ,  String userSearch ,  String groupSearchBase ,  String managerDN ,  String managerPassword ,  boolean inhibitInferRootDN ,  boolean disableMailAddressResolver ,  CacheConfiguration cache )  {  this  ( server , rootDN , userSearchBase , userSearch , groupSearchBase , null , null , managerDN , managerPassword , inhibitInferRootDN , disableMailAddressResolver , cache ) ; }    @ Deprecated public LDAPSecurityRealm  (  String server ,  String rootDN ,  String userSearchBase ,  String userSearch ,  String groupSearchBase ,  String groupSearchFilter ,  String groupMembershipFilter ,  String managerDN ,  String managerPassword ,  boolean inhibitInferRootDN ,  boolean disableMailAddressResolver ,  CacheConfiguration cache )  {  this  ( server , rootDN , userSearchBase , userSearch , groupSearchBase , groupSearchFilter , groupMembershipFilter , managerDN , managerPassword , inhibitInferRootDN , disableMailAddressResolver , cache , null ) ; }    @ Deprecated public LDAPSecurityRealm  (  String server ,  String rootDN ,  String userSearchBase ,  String userSearch ,  String groupSearchBase ,  String groupSearchFilter ,  String groupMembershipFilter ,  String managerDN ,  String managerPassword ,  boolean inhibitInferRootDN ,  boolean disableMailAddressResolver ,  CacheConfiguration cache ,   EnvironmentProperty  [ ] environmentProperties )  {  this  ( server , rootDN , userSearchBase , userSearch , groupSearchBase , groupSearchFilter , groupMembershipFilter , managerDN , managerPassword , inhibitInferRootDN , disableMailAddressResolver , cache , environmentProperties , null , null ) ; }    @ Deprecated public LDAPSecurityRealm  (  String server ,  String rootDN ,  String userSearchBase ,  String userSearch ,  String groupSearchBase ,  String groupSearchFilter ,  String groupMembershipFilter ,  String managerDN ,  String managerPassword ,  boolean inhibitInferRootDN ,  boolean disableMailAddressResolver ,  CacheConfiguration cache ,   EnvironmentProperty  [ ] environmentProperties ,  String displayNameAttributeName ,  String mailAddressAttributeName )  {  this  ( server , rootDN , userSearchBase , userSearch , groupSearchBase , groupSearchFilter , groupMembershipFilter , managerDN ,  Secret . fromString  ( managerPassword ) , inhibitInferRootDN , disableMailAddressResolver , cache , environmentProperties , null , null ) ; }    @ Deprecated public LDAPSecurityRealm  (  String server ,  String rootDN ,  String userSearchBase ,  String userSearch ,  String groupSearchBase ,  String groupSearchFilter ,  String groupMembershipFilter ,  String managerDN ,  Secret managerPasswordSecret ,  boolean inhibitInferRootDN ,  boolean disableMailAddressResolver ,  CacheConfiguration cache ,   EnvironmentProperty  [ ] environmentProperties ,  String displayNameAttributeName ,  String mailAddressAttributeName )  {  this  ( server , rootDN , userSearchBase , userSearch , groupSearchBase , groupSearchFilter ,  new FromGroupSearchLDAPGroupMembershipStrategy  ( groupMembershipFilter ) , managerDN , managerPasswordSecret , inhibitInferRootDN , disableMailAddressResolver , cache , environmentProperties , displayNameAttributeName , mailAddressAttributeName ) ; }    @ Deprecated public LDAPSecurityRealm  (  String server ,  String rootDN ,  String userSearchBase ,  String userSearch ,  String groupSearchBase ,  String groupSearchFilter ,  LDAPGroupMembershipStrategy groupMembershipStrategy ,  String managerDN ,  Secret managerPasswordSecret ,  boolean inhibitInferRootDN ,  boolean disableMailAddressResolver ,  CacheConfiguration cache ,   EnvironmentProperty  [ ] environmentProperties ,  String displayNameAttributeName ,  String mailAddressAttributeName )  {  this  ( server , rootDN , userSearchBase , userSearch , groupSearchBase , groupSearchFilter , groupMembershipStrategy , managerDN , managerPasswordSecret , inhibitInferRootDN , disableMailAddressResolver , cache , environmentProperties , displayNameAttributeName , mailAddressAttributeName ,  IdStrategy . CASE_INSENSITIVE ,  IdStrategy . CASE_INSENSITIVE ) ; }    @ Deprecated public  @ DataBoundConstructor LDAPSecurityRealm  (  String server ,  String rootDN ,  String userSearchBase ,  String userSearch ,  String groupSearchBase ,  String groupSearchFilter ,  LDAPGroupMembershipStrategy groupMembershipStrategy ,  String managerDN ,  Secret managerPasswordSecret ,  boolean inhibitInferRootDN ,  boolean disableMailAddressResolver ,  CacheConfiguration cache ,   EnvironmentProperty  [ ] environmentProperties ,  String displayNameAttributeName ,  String mailAddressAttributeName ,  IdStrategy userIdStrategy ,  IdStrategy groupIdStrategy )  {  this  (  createLdapConfiguration  ( server , rootDN , userSearchBase , userSearch , groupSearchBase , groupSearchFilter , groupMembershipStrategy , managerDN , managerPasswordSecret , inhibitInferRootDN , environmentProperties , displayNameAttributeName , mailAddressAttributeName ) , disableMailAddressResolver , cache , userIdStrategy , groupIdStrategy ) ; }    @ DataBoundConstructor public LDAPSecurityRealm  (   List  < LDAPConfiguration > configurations ,  boolean disableMailAddressResolver ,  CacheConfiguration cache ,  IdStrategy userIdStrategy ,  IdStrategy groupIdStrategy )  {    this . configurations = configurations ;    this . disableMailAddressResolver = disableMailAddressResolver ;    this . cache = cache ;    this . userIdStrategy = userIdStrategy ;    this . groupIdStrategy = groupIdStrategy ; }   private static  List  < LDAPConfiguration > createLdapConfiguration  (  String server ,  String rootDN ,  String userSearchBase ,  String userSearch ,  String groupSearchBase ,  String groupSearchFilter ,  LDAPGroupMembershipStrategy groupMembershipStrategy ,  String managerDN ,  Secret managerPasswordSecret ,  boolean inhibitInferRootDN ,   EnvironmentProperty  [ ] environmentProperties ,  String displayNameAttributeName ,  String mailAddressAttributeName )  {  LDAPConfiguration  conf =  new LDAPConfiguration  ( server , rootDN , inhibitInferRootDN , managerDN , managerPasswordSecret ) ;   conf . setUserSearchBase  ( userSearchBase ) ;   conf . setUserSearch  ( userSearch ) ;   conf . setGroupSearchBase  ( groupSearchBase ) ;   conf . setGroupSearchFilter  ( groupSearchFilter ) ;   conf . setGroupMembershipStrategy  ( groupMembershipStrategy ) ;   conf . setEnvironmentProperties  ( environmentProperties ) ;   conf . setDisplayNameAttributeName  ( displayNameAttributeName ) ;   conf . setMailAddressAttributeName  ( mailAddressAttributeName ) ;  return  Collections . singletonList  ( conf ) ; }   public  List  < LDAPConfiguration > getConfigurations  ( )  {  return configurations ; }   private boolean hasConfiguration  ( )  {  return   configurations != null &&  !  configurations . isEmpty  ( ) ; }   private Object readResolve  ( )  {  if  (  managerPassword != null )  {   managerPasswordSecret =  Secret . fromString  (  Scrambler . descramble  ( managerPassword ) ) ;   managerPassword = null ; }  if  (  server != null )  {  LDAPConfiguration  conf =  new LDAPConfiguration  ( server , rootDN , inhibitInferRootDN , managerDN , managerPasswordSecret ) ;   server = null ;   rootDN = null ;   managerDN = null ;   managerPasswordSecret = null ;   conf . setMailAddressAttributeName  ( mailAddressAttributeName ) ;   mailAddressAttributeName = null ;   conf . setDisplayNameAttributeName  ( displayNameAttributeName ) ;   displayNameAttributeName = null ;   conf . setExtraEnvVars  ( extraEnvVars ) ;   extraEnvVars = null ;  if  (  groupMembershipStrategy == null )  {   conf . setGroupMembershipStrategy  (  new FromGroupSearchLDAPGroupMembershipStrategy  ( groupMembershipFilter ) ) ;   groupMembershipFilter = null ; } else  {   conf . setGroupMembershipStrategy  ( groupMembershipStrategy ) ;   groupMembershipStrategy = null ; }   conf . setGroupSearchBase  ( groupSearchBase ) ;   groupSearchBase = null ;   conf . setGroupSearchFilter  ( groupSearchFilter ) ;   groupSearchFilter = null ;   conf . setUserSearch  ( userSearch ) ;   userSearch = null ;   conf . setUserSearchBase  ( userSearchBase ) ;   userSearchBase = null ;    this . configurations =  new  ArrayList  < >  ( ) ;   configurations . add  ( conf ) ; }  return this ; }    @ Deprecated  @ Restricted  (  DoNotUse . class ) public String getServerUrl  ( )  {  return   hasConfiguration  ( ) ?   configurations . get  ( 0 ) . getServerUrl  ( ) : null ; }    @ Override public IdStrategy getUserIdStrategy  ( )  {  return   userIdStrategy == null ?  IdStrategy . CASE_INSENSITIVE : userIdStrategy ; }    @ Override public IdStrategy getGroupIdStrategy  ( )  {  return   groupIdStrategy == null ?  IdStrategy . CASE_INSENSITIVE : groupIdStrategy ; }   public CacheConfiguration getCache  ( )  {  return cache ; }   public Integer getCacheSize  ( )  {  return   cache == null ? null :  cache . getSize  ( ) ; }   public Integer getCacheTTL  ( )  {  return   cache == null ? null :  cache . getTtl  ( ) ; }    @ Deprecated  @ Restricted  (  DoNotUse . class ) public String getGroupMembershipFilter  ( )  {  return   hasConfiguration  ( ) ?   configurations . get  ( 0 ) . getGroupSearchFilter  ( ) : null ; }    @ Deprecated  @ Restricted  (  DoNotUse . class ) public LDAPGroupMembershipStrategy getGroupMembershipStrategy  ( )  {  return   hasConfiguration  ( ) ?   configurations . get  ( 0 ) . getGroupMembershipStrategy  ( ) : null ; }    @ Deprecated  @ Restricted  (  DoNotUse . class ) public String getGroupSearchFilter  ( )  {  return   hasConfiguration  ( ) ?   configurations . get  ( 0 ) . getGroupSearchFilter  ( ) : null ; }    @ Deprecated  @ Restricted  (  DoNotUse . class ) public  Map  < String , String > getExtraEnvVars  ( )  {  return   hasConfiguration  ( ) ?   configurations . get  ( 0 ) . getExtraEnvVars  ( ) :  Collections .  < String , String > emptyMap  ( ) :  Collections . unmodifiableMap  ( extraEnvVars ) ; }    @ Deprecated  @ Restricted  (  DoNotUse . class ) public  EnvironmentProperty  [ ] getEnvironmentProperties  ( )  {  return   hasConfiguration  ( ) ?   configurations . get  ( 0 ) . getEnvironmentProperties  ( ) :  new EnvironmentProperty  [ 0 ] ; }    @ Deprecated  @ Restricted  (  DoNotUse . class ) public String getManagerPassword  ( )  {  return   hasConfiguration  ( ) ?   configurations . get  ( 0 ) . getManagerPassword  ( ) : null ; }    @ Deprecated  @ Restricted  (  DoNotUse . class ) public Secret getManagerPasswordSecret  ( )  {  return   hasConfiguration  ( ) ?   configurations . get  ( 0 ) . getManagerPasswordSecret  ( ) : null ; }    @ Deprecated  @ Restricted  (  DoNotUse . class ) public String getLDAPURL  ( )  {  return   hasConfiguration  ( ) ?   configurations . get  ( 0 ) . getLDAPURL  ( ) : null ; }    @ Deprecated  @ Restricted  (  DoNotUse . class ) public String getDisplayNameAttributeName  ( )  {  return   hasConfiguration  ( ) ?   configurations . get  ( 0 ) . getDisplayNameAttributeName  ( ) :  DescriptorImpl . DEFAULT_DISPLAYNAME_ATTRIBUTE_NAME ; }    @ Deprecated  @ Restricted  (  DoNotUse . class ) public String getMailAddressAttributeName  ( )  {  return   hasConfiguration  ( ) ?   configurations . get  ( 0 ) . getMailAddressAttributeName  ( ) :  DescriptorImpl . DEFAULT_MAILADDRESS_ATTRIBUTE_NAME ; }    @ CheckForNull  @ Restricted  (  NoExternalUse . class ) public LDAPConfiguration getConfigurationFor  (  LdapUserDetails d )  {  if  (  d instanceof DelegatedLdapUserDetails )  {  return  getConfigurationFor  (   (  ( DelegatedLdapUserDetails ) d ) . getServer  ( ) ) ; } else  if  (   hasConfiguration  ( ) &&   configurations . size  ( ) == 1 )  {  return  configurations . get  ( 0 ) ; } else  {  return null ; } }    @ CheckForNull  @ Restricted  (  NoExternalUse . class ) public LDAPConfiguration getConfigurationFor  (  String server )  {  for ( LDAPConfiguration configuration : configurations )  {  if  (   configuration . getServer  ( ) . equals  ( server ) )  {  return configuration ; } }  return null ; }    @ Restricted  (  NoExternalUse . class ) public static String toProviderUrl  (  String serverUrl ,  String rootDN )  {  StringBuilder  buf =  new StringBuilder  ( ) ;  boolean  first = true ;  for ( String s :  serverUrl . split  ( "\\s+" ) )  {  if  (    s . trim  ( ) . length  ( ) == 0 )  continue ;   s =  getProviderUrl  ( s , rootDN ) ;  if  (  s != null )  {  if  ( first )   first = false ; else   buf . append  ( ' ' ) ;   buf . append  ( s ) ; } }  return  buf . toString  ( ) ; }   private static String getProviderUrl  (  String server ,  String rootDN )  {   server =  addPrefix  ( server ) ;  if  (  !  server . endsWith  ( "/" ) )  {   server =  server + '/' ; }  if  (  rootDN != null )  {   rootDN =  rootDN . trim  ( ) ;  if  (  !  rootDN . isEmpty  ( ) )  {  try  {   server =  server +   new URI  ( null , null , rootDN , null ) . toASCIIString  ( ) ; }  catch (   URISyntaxException e )  {   LOGGER . log  (  Level . WARNING ,  "Unable to build URL with rootDN: " + server , e ) ;  return null ; } } }  return server ; }    @ Override  @ Nonnull public SecurityComponents createSecurityComponents  ( )  {  LDAPAuthenticationManager  manager =  new LDAPAuthenticationManager  ( ) ;  DelegateLDAPUserDetailsService  details =  new DelegateLDAPUserDetailsService  ( ) ;  for ( LDAPConfiguration conf : configurations )  {  WebApplicationContext  appContext =  conf . createApplicationContext  ( ) ;   manager . addDelegate  (  findBean  (  AuthenticationManager . class , appContext ) ) ;   details . addDelegate  (  new LDAPUserDetailsService  ( appContext ,  conf . getGroupMembershipStrategy  ( ) ,  conf . getServer  ( ) ) ) ; }  return  new SecurityComponents  ( manager , details ) ; }    @ Override protected UserDetails authenticate  (  String username ,  String password )  throws AuthenticationException  {  return  updateUserDetails  (  ( UserDetails )     getSecurityComponents  ( ) . manager . authenticate  (  new UsernamePasswordAuthenticationToken  (  fixUsername  ( username ) , password ) ) . getPrincipal  ( ) ) ; }    @ Override public UserDetails loadUserByUsername  (  String username )  throws UsernameNotFoundException , DataAccessException  {  return  updateUserDetails  (    getSecurityComponents  ( ) . userDetails . loadUserByUsername  (  fixUsername  ( username ) ) ) ; }   public Authentication updateUserDetails  (  Authentication authentication )  {   updateUserDetails  (  ( UserDetails )  authentication . getPrincipal  ( ) ) ;  return authentication ; }   public UserDetails updateUserDetails  (  UserDetails userDetails )  {  if  (  userDetails instanceof LdapUserDetails )  {   updateUserDetails  (  ( LdapUserDetails ) userDetails ) ; }  return userDetails ; }   public LdapUserDetails updateUserDetails  (  LdapUserDetails d )  {    hudson . model . User  u =    hudson . model . User . get  (  fixUsername  (  d . getUsername  ( ) ) ) ;  LDAPConfiguration  configuration =  getConfigurationFor  ( d ) ;  String  displayNameAttributeName =   configuration != null ?  configuration . getDisplayNameAttributeName  ( ) :  DescriptorImpl . DEFAULT_DISPLAYNAME_ATTRIBUTE_NAME ;  String  mailAddressAttributeName =   configuration != null ?  configuration . getMailAddressAttributeName  ( ) :  DescriptorImpl . DEFAULT_MAILADDRESS_ATTRIBUTE_NAME ;  try  {  Attribute  attribute =   d . getAttributes  ( ) . get  ( displayNameAttributeName ) ;  String  displayName =   attribute == null ? null :  ( String )  attribute . get  ( ) ;  if  (    StringUtils . isNotBlank  ( displayName ) &&   u . getId  ( ) . equals  (  u . getFullName  ( ) ) &&  !   u . getFullName  ( ) . equals  ( displayName ) )  {   u . setFullName  ( displayName ) ; } }  catch (   NamingException e )  {   LOGGER . log  (  Level . FINEST , "Could not retrieve display name attribute" , e ) ; }  if  (  ! disableMailAddressResolver )  {  try  {  Attribute  attribute =   d . getAttributes  ( ) . get  ( mailAddressAttributeName ) ;  String  mailAddress =   attribute == null ? null :  ( String )  attribute . get  ( ) ;  if  (  StringUtils . isNotBlank  ( mailAddress ) )  {  UserProperty  existing =  u . getProperty  (  UserProperty . class ) ;  if  (   existing == null ||  !  existing . hasExplicitlyConfiguredAddress  ( ) )   u . addProperty  (  new  Mailer . UserProperty  ( mailAddress ) ) ; } }  catch (   NamingException e )  {   LOGGER . log  (  Level . FINEST , "Could not retrieve email address attribute" , e ) ; }  catch (   IOException e )  {   LOGGER . log  (  Level . WARNING , "Failed to associate the e-mail address" , e ) ; } }  return d ; }    @ Override public GroupDetails loadGroupByGroupname  (  String groupname )  throws UsernameNotFoundException , DataAccessException  {   groupname =  fixGroupname  ( groupname ) ;   Set  < String >  cachedGroups ;  if  (  cache != null )  {   final  CacheEntry  <  Set  < String > >  cached ;  synchronized  ( this )  {   cached =   groupDetailsCache != null ?  groupDetailsCache . get  ( groupname ) : null ; }  if  (   cached != null &&  cached . isValid  ( ) )  {   cachedGroups =  cached . getValue  ( ) ; } else  {   cachedGroups = null ; } } else  {   cachedGroups = null ; }   final  Set  < String >  groups =   cachedGroups != null ? cachedGroups :  searchForGroupName  ( groupname ) ;  if  (    cache != null &&  cachedGroups == null &&  !  groups . isEmpty  ( ) )  {  synchronized  ( this )  {  if  (  groupDetailsCache == null )  {   groupDetailsCache =  new  CacheMap  < String ,  Set  < String > >  (  cache . getSize  ( ) ) ; }   groupDetailsCache . put  ( groupname ,  new  CacheEntry  <  Set  < String > >  (  cache . getTtl  ( ) , groups ) ) ; } }  if  (  groups . isEmpty  ( ) )  throw  new UsernameNotFoundException  ( groupname ) ;  return  new GroupDetailsImpl  (  fixGroupname  (   groups . iterator  ( ) . next  ( ) ) ) ; }   private  Set  < String > searchForGroupName  (  String groupname )  {   Set  < String >  groups =  new  TreeSet  < >  ( ) ;  for ( LDAPConfiguration conf : configurations )  {  String  searchBase =    conf . getGroupSearchBase  ( ) != null ?  conf . getGroupSearchBase  ( ) : "" ;  String  searchFilter =    conf . getGroupSearchFilter  ( ) != null ?  conf . getGroupSearchFilter  ( ) : GROUP_SEARCH ;   groups . addAll  (   conf . getLdapTemplate  ( ) . searchForSingleAttributeValues  ( searchBase , searchFilter ,  new String  [ ]  { groupname } , "cn" ) ) ; }  return groups ; }   private static String fixGroupname  (  String groupname )  {  return  FORCE_GROUPNAME_LOWERCASE ?  groupname . toLowerCase  ( ) : groupname ; }   private static String fixUsername  (  String username )  {  return  FORCE_USERNAME_LOWERCASE ?  username . toLowerCase  ( ) : username ; }   private static class GroupDetailsImpl  extends GroupDetails  {   private String  name ;   public GroupDetailsImpl  (  String name )  {    this . name = name ; }   public String getName  ( )  {  return name ; } }   private class LDAPAuthenticationManager  implements  AuthenticationManager  {   private final  List  < AuthenticationManager >  delegates ;   private LDAPAuthenticationManager  ( )  {    this . delegates =  new  ArrayList  < >  ( ) ; }   private void addDelegate  (  AuthenticationManager delegate )  {    this . delegates . add  ( delegate ) ; }   public Authentication authenticate  (  Authentication authentication )  throws AuthenticationException  {  BadCredentialsException  lastException = null ;  for ( AuthenticationManager delegate : delegates )  {  try  {  Authentication  a =  delegate . authenticate  ( authentication ) ;  return  updateUserDetails  ( a ) ; }  catch (   BadCredentialsException e )  {   lastException = e ; } }  if  (  lastException != null )  {  throw lastException ; } else  {  throw  new UserMayOrMayNotExistException  ( "This is not intentional." , authentication ) ; } } }   protected static class DelegatedLdapUserDetails  implements  LdapUserDetails , Serializable  {   private static final  long  serialVersionUID = 1L ;   private final LdapUserDetails  userDetails ;   private final String  server ;   public DelegatedLdapUserDetails  (    @ Nonnull LdapUserDetails userDetails ,    @ Nonnull String server )  {    this . userDetails = userDetails ;    this . server = server ; }    @ Override public Attributes getAttributes  ( )  {  return  userDetails . getAttributes  ( ) ; }    @ Override public  Control  [ ] getControls  ( )  {  return  userDetails . getControls  ( ) ; }    @ Override public String getDn  ( )  {  return  userDetails . getDn  ( ) ; }    @ Override public  GrantedAuthority  [ ] getAuthorities  ( )  {  return  userDetails . getAuthorities  ( ) ; }    @ Override public String getPassword  ( )  {  return  userDetails . getPassword  ( ) ; }    @ Override public String getUsername  ( )  {  return  userDetails . getUsername  ( ) ; }    @ Override public boolean isAccountNonExpired  ( )  {  return  userDetails . isAccountNonExpired  ( ) ; }    @ Override public boolean isAccountNonLocked  ( )  {  return  userDetails . isAccountNonLocked  ( ) ; }    @ Override public boolean isCredentialsNonExpired  ( )  {  return  userDetails . isCredentialsNonExpired  ( ) ; }    @ Override public boolean isEnabled  ( )  {  return  userDetails . isEnabled  ( ) ; }   public LdapUserDetails getUserDetails  ( )  {  return userDetails ; }   public String getServer  ( )  {  return server ; } }   private static class DelegateLDAPUserDetailsService  implements  UserDetailsService  {   private final  List  < LDAPUserDetailsService >  delegates ;   public DelegateLDAPUserDetailsService  ( )  {   delegates =  new  ArrayList  < >  ( ) ; }   public void addDelegate  (  LDAPUserDetailsService delegate )  {   delegates . add  ( delegate ) ; }   public boolean contains  (  LDAPUserDetailsService delegate )  {  return  delegates . contains  ( delegate ) ; }    @ Override public UserDetails loadUserByUsername  (  String username )  throws UsernameNotFoundException , DataAccessException  {  UsernameNotFoundException  lastUNFE = null ;  DataAccessException  lastDAE = null ;  for ( LDAPUserDetailsService delegate : delegates )  {  try  {  LdapUserDetails  userDetails =  delegate . loadUserByUsername  ( username ) ;  return  new DelegatedLdapUserDetails  ( userDetails ,  delegate . server ) ; }  catch (   UsernameNotFoundException e )  {   lastUNFE = e ; }  catch (   DataAccessException e )  {   LOGGER . log  (  Level . WARNING , "An LDAP connection seems to be broken, will try the next configuration." , e ) ;   lastDAE = e ; } }  if  (  lastUNFE != null )  {  throw lastUNFE ; } else  if  (  lastDAE != null )  {  throw lastDAE ; } else  {  throw  new UserMayOrMayNotExistException  ( "This is not intentional." , username ) ; } } }   public static class LDAPUserDetailsService  implements  UserDetailsService  {   public final LdapUserSearch  ldapSearch ;   public final LdapAuthoritiesPopulator  authoritiesPopulator ;   public final LDAPGroupMembershipStrategy  groupMembershipStrategy ;   public final String  server ;   private final LRUMap  attributesCache =  new LRUMap  ( 32 ) ;    @ Deprecated LDAPUserDetailsService  (  WebApplicationContext appContext )  {  this  ( appContext , null , null ) ; }    @ Deprecated LDAPUserDetailsService  (  LdapUserSearch ldapSearch ,  LdapAuthoritiesPopulator authoritiesPopulator )  {  this  ( ldapSearch , authoritiesPopulator , null , null ) ; }  LDAPUserDetailsService  (  LdapUserSearch ldapSearch ,  LdapAuthoritiesPopulator authoritiesPopulator ,  LDAPGroupMembershipStrategy groupMembershipStrategy ,  String server )  {    this . ldapSearch = ldapSearch ;    this . authoritiesPopulator = authoritiesPopulator ;    this . groupMembershipStrategy = groupMembershipStrategy ;    this . server = server ; }    @ Deprecated public LDAPUserDetailsService  (  WebApplicationContext appContext ,  LDAPGroupMembershipStrategy groupMembershipStrategy )  {  this  (  findBean  (  LdapUserSearch . class , appContext ) ,  findBean  (  LdapAuthoritiesPopulator . class , appContext ) , groupMembershipStrategy , null ) ; }   public LDAPUserDetailsService  (  WebApplicationContext appContext ,  LDAPGroupMembershipStrategy groupMembershipStrategy ,  String server )  {  this  (  findBean  (  LdapUserSearch . class , appContext ) ,  findBean  (  LdapAuthoritiesPopulator . class , appContext ) , groupMembershipStrategy , server ) ; }   public LdapUserDetails loadUserByUsername  (  String username )  throws UsernameNotFoundException , DataAccessException  {   username =  fixUsername  ( username ) ;  try  {   final Jenkins  jenkins =  Jenkins . getInstance  ( ) ;   final SecurityRealm  securityRealm =   jenkins == null ? null :  jenkins . getSecurityRealm  ( ) ;  if  (   securityRealm instanceof LDAPSecurityRealm &&  (     securityRealm . getSecurityComponents  ( ) . userDetails == this ||  (     securityRealm . getSecurityComponents  ( ) . userDetails instanceof DelegateLDAPUserDetailsService &&   (  ( DelegateLDAPUserDetailsService )   securityRealm . getSecurityComponents  ( ) . userDetails ) . contains  ( this ) ) ) )  {  LDAPSecurityRealm  ldapSecurityRealm =  ( LDAPSecurityRealm ) securityRealm ;  if  (   ldapSecurityRealm . cache != null )  {   final  CacheEntry  < LdapUserDetails >  cached ;  synchronized  ( ldapSecurityRealm )  {   cached =   (   ldapSecurityRealm . userDetailsCache != null ) ?   ldapSecurityRealm . userDetailsCache . get  ( username ) : null ; }  if  (   cached != null &&  cached . isValid  ( ) )  {  return  cached . getValue  ( ) ; } } }  LdapUserDetails  ldapUser =  ldapSearch . searchForUser  ( username ) ;  if  (  ldapUser != null )  {   LdapUserDetailsImpl . Essence  user =  new  LdapUserDetailsImpl . Essence  ( ldapUser ) ;  Attributes  v =  ldapUser . getAttributes  ( ) ;  if  (  v instanceof BasicAttributes )  {  synchronized  ( attributesCache )  {  Attributes  vv =  ( Attributes )  attributesCache . get  ( v ) ;  if  (  vv == null )   attributesCache . put  ( v ,  vv = v ) ;   user . setAttributes  ( vv ) ; } }   GrantedAuthority  [ ]  extraAuthorities =   groupMembershipStrategy == null ?  authoritiesPopulator . getGrantedAuthorities  ( ldapUser ) :  groupMembershipStrategy . getGrantedAuthorities  ( ldapUser ) ;  for ( GrantedAuthority extraAuthority : extraAuthorities )  {  if  ( FORCE_GROUPNAME_LOWERCASE )  {   user . addAuthority  (  new GrantedAuthorityImpl  (   extraAuthority . getAuthority  ( ) . toLowerCase  ( ) ) ) ; } else  {   user . addAuthority  ( extraAuthority ) ; } }   ldapUser =  user . createUserDetails  ( ) ; }  if  (   securityRealm instanceof LDAPSecurityRealm &&  (     securityRealm . getSecurityComponents  ( ) . userDetails == this ||  (     securityRealm . getSecurityComponents  ( ) . userDetails instanceof DelegateLDAPUserDetailsService &&   (  ( DelegateLDAPUserDetailsService )   securityRealm . getSecurityComponents  ( ) . userDetails ) . contains  ( this ) ) ) )  {  LDAPSecurityRealm  ldapSecurityRealm =  ( LDAPSecurityRealm ) securityRealm ;  if  (   ldapSecurityRealm . cache != null )  {  synchronized  ( ldapSecurityRealm )  {  if  (   ldapSecurityRealm . userDetailsCache == null )  {    ldapSecurityRealm . userDetailsCache =  new  CacheMap  < String , LdapUserDetails >  (   ldapSecurityRealm . cache . getSize  ( ) ) ; }    ldapSecurityRealm . userDetailsCache . put  ( username ,  new  CacheEntry  < LdapUserDetails >  (   ldapSecurityRealm . cache . getTtl  ( ) ,  ldapSecurityRealm . updateUserDetails  ( ldapUser ) ) ) ; } } }  return ldapUser ; }  catch (   LdapDataAccessException e )  {   LOGGER . log  (  Level . WARNING ,  "Failed to search LDAP for username=" + username , e ) ;  throw  new UserMayOrMayNotExistException  (  e . getMessage  ( ) , e ) ; } } }    @ Extension public static final class MailAdressResolverImpl  extends MailAddressResolver  {   public String findMailAddressFor  (  User u )  {   final Jenkins  jenkins =  Jenkins . getInstance  ( ) ;  if  (  jenkins == null )  {  return null ; }  SecurityRealm  realm =  jenkins . getSecurityRealm  ( ) ;  if  (  !  (  realm instanceof LDAPSecurityRealm ) )  {  return null ; }  if  (   (  ( LDAPSecurityRealm ) realm ) . disableMailAddressResolver )  {   LOGGER . info  ( "LDAPSecurityRealm MailAddressResolver is disabled" ) ;  return null ; }  try  {  LdapUserDetails  details =  ( LdapUserDetails )    realm . getSecurityComponents  ( ) . userDetails . loadUserByUsername  (  u . getId  ( ) ) ;  Attribute  mail =   details . getAttributes  ( ) . get  (   (  ( LDAPSecurityRealm ) realm ) . getMailAddressAttributeName  ( ) ) ;  if  (  mail == null )  return null ;  return  ( String )  mail . get  ( ) ; }  catch (   UsernameNotFoundException e )  {   LOGGER . log  (  Level . FINE , "Failed to look up LDAP for e-mail address" , e ) ;  return null ; }  catch (   DataAccessException e )  {   LOGGER . log  (  Level . FINE , "Failed to look up LDAP for e-mail address" , e ) ;  return null ; }  catch (   NamingException e )  {   LOGGER . log  (  Level . FINE , "Failed to look up LDAP for e-mail address" , e ) ;  return null ; }  catch (   AcegiSecurityException e )  {   LOGGER . log  (  Level . FINE , "Failed to look up LDAP for e-mail address" , e ) ;  return null ; } } }   public static final class AuthoritiesPopulatorImpl  extends DefaultLdapAuthoritiesPopulator  {  String  rolePrefix = "ROLE_" ;  boolean  convertToUpperCase = true ;   public AuthoritiesPopulatorImpl  (  InitialDirContextFactory initialDirContextFactory ,  String groupSearchBase )  {  super  ( initialDirContextFactory ,  fixNull  ( groupSearchBase ) ) ;   super . setRolePrefix  ( "" ) ;   super . setConvertToUpperCase  ( false ) ; }    @ Override protected Set getAdditionalRoles  (  LdapUserDetails ldapUser )  {  return  Collections . singleton  ( AUTHENTICATED_AUTHORITY ) ; }    @ Override public void setRolePrefix  (  String rolePrefix )  {    this . rolePrefix = rolePrefix ; }    @ Override public void setConvertToUpperCase  (  boolean convertToUpperCase )  {    this . convertToUpperCase = convertToUpperCase ; }    @ Override public Set getGroupMembershipRoles  (  String userDn ,  String username )  {   Set  < GrantedAuthority >  names =  super . getGroupMembershipRoles  ( userDn , username ) ;   Set  < GrantedAuthority >  r =  new  HashSet  < GrantedAuthority >  (   names . size  ( ) * 2 ) ;   r . addAll  ( names ) ;  for ( GrantedAuthority ga : names )  {  String  role =  ga . getAuthority  ( ) ;  if  ( convertToUpperCase )   role =  role . toUpperCase  ( ) ;   r . add  (  new GrantedAuthorityImpl  (  rolePrefix + role ) ) ; }  return r ; } }    @ Extension public static final class DescriptorImpl  extends  Descriptor  < SecurityRealm >  {   public static final String  DEFAULT_DISPLAYNAME_ATTRIBUTE_NAME = "displayname" ;   public static final String  DEFAULT_MAILADDRESS_ATTRIBUTE_NAME = "mail" ;   public static final String  DEFAULT_USER_SEARCH = "uid={0}" ;   public String getDisplayName  ( )  {  return  Messages . LDAPSecurityRealm_DisplayName  ( ) ; }   public IdStrategy getDefaultIdStrategy  ( )  {  return  IdStrategy . CASE_INSENSITIVE ; } }   private static String addPrefix  (  String server )  {  if  (  server . contains  ( "://" ) )  return server ; else  return  "ldap://" + server ; }    @ Restricted  (  NoExternalUse . class ) public static final Logger  LOGGER =  Logger . getLogger  (   LDAPSecurityRealm . class . getName  ( ) ) ;   public static final String  GROUP_SEARCH =  System . getProperty  (    LDAPSecurityRealm . class . getName  ( ) + ".groupSearch" , "(& (cn={0}) (| (objectclass=groupOfNames) (objectclass=groupOfUniqueNames) (objectclass=posixGroup)))" ) ;   public static class CacheConfiguration  extends  AbstractDescribableImpl  < CacheConfiguration >  {   private final  int  size ;   private final  int  ttl ;    @ DataBoundConstructor public CacheConfiguration  (   int size ,   int ttl )  {    this . size =  Math . max  ( 10 ,  Math . min  ( size , 1000 ) ) ;    this . ttl =  Math . max  ( 30 ,  Math . min  ( ttl , 3600 ) ) ; }   public  int getSize  ( )  {  return size ; }   public  int getTtl  ( )  {  return ttl ; }    @ Extension public static class DescriptorImpl  extends  Descriptor  < CacheConfiguration >  {    @ Override public String getDisplayName  ( )  {  return "" ; }   public ListBoxModel doFillSizeItems  ( )  {  ListBoxModel  m =  new ListBoxModel  ( ) ;   m . add  ( "10" ) ;   m . add  ( "20" ) ;   m . add  ( "50" ) ;   m . add  ( "100" ) ;   m . add  ( "200" ) ;   m . add  ( "500" ) ;   m . add  ( "1000" ) ;  return m ; }   public ListBoxModel doFillTtlItems  ( )  {  ListBoxModel  m =  new ListBoxModel  ( ) ;  for (  int ttl :  new  int  [ ]  { 30 , 60 , 120 , 300 , 600 , 900 , 1800 , 3600 } )  {   m . add  (  Util . getTimeSpanString  (  ttl * 1000L ) ,  Integer . toString  ( ttl ) ) ; }  return m ; } } }   private static class CacheEntry  <  T >  {   private final  long  expires ;   private final T  value ;   public CacheEntry  (   int ttlSeconds ,  T value )  {    this . expires =   System . currentTimeMillis  ( ) +   TimeUnit . SECONDS . toMillis  ( ttlSeconds ) ;    this . value = value ; }   public T getValue  ( )  {  return value ; }   public boolean isValid  ( )  {  return   System . currentTimeMillis  ( ) < expires ; } }   private static class CacheMap  <  K ,  V >  extends  LinkedHashMap  < K ,  CacheEntry  < V > >  {   private final  int  cacheSize ;   public CacheMap  (   int cacheSize )  {  super  (  cacheSize + 1 ) ;    this . cacheSize = cacheSize ; }    @ Override protected boolean removeEldestEntry  (    Map . Entry  < K ,  CacheEntry  < V > > eldest )  {  return     size  ( ) > cacheSize ||   eldest . getValue  ( ) == null ||  !   eldest . getValue  ( ) . isValid  ( ) ; } }   public static class EnvironmentProperty  extends  AbstractDescribableImpl  < EnvironmentProperty >  implements  Serializable  {   private final String  name ;   private final String  value ;    @ DataBoundConstructor public EnvironmentProperty  (  String name ,  String value )  {    this . name = name ;    this . value = value ; }   public String getName  ( )  {  return name ; }   public String getValue  ( )  {  return value ; }   public static  Map  < String , String > toMap  (   List  < EnvironmentProperty > properties )  {  if  (  properties != null )  {   final  Map  < String , String >  result =  new  LinkedHashMap  < String , String >  ( ) ;  for ( EnvironmentProperty property : properties )  {   result . put  (  property . getName  ( ) ,  property . getValue  ( ) ) ; }  return result ; }  return null ; }    @ Extension public static class DescriptorImpl  extends  Descriptor  < EnvironmentProperty >  {    @ Override public String getDisplayName  ( )  {  return "" ; } } } }