  package   com . mitchellbosecke . pebble ;   import      com . github . benmanes . caffeine . cache . Cache ;  import      com . github . benmanes . caffeine . cache . Caffeine ;  import     com . mitchellbosecke . pebble . cache . CacheKey ;  import     com . mitchellbosecke . pebble . error . LoaderException ;  import     com . mitchellbosecke . pebble . error . ParserException ;  import     com . mitchellbosecke . pebble . extension . Extension ;  import     com . mitchellbosecke . pebble . extension . ExtensionRegistry ;  import     com . mitchellbosecke . pebble . extension . NodeVisitorFactory ;  import      com . mitchellbosecke . pebble . extension . core . AttributeResolverExtension ;  import      com . mitchellbosecke . pebble . extension . core . CoreExtension ;  import      com . mitchellbosecke . pebble . extension . escaper . EscaperExtension ;  import      com . mitchellbosecke . pebble . extension . escaper . EscapingStrategy ;  import      com . mitchellbosecke . pebble . extension . i18n . I18nExtension ;  import     com . mitchellbosecke . pebble . lexer . LexerImpl ;  import     com . mitchellbosecke . pebble . lexer . Syntax ;  import     com . mitchellbosecke . pebble . lexer . TokenStream ;  import     com . mitchellbosecke . pebble . loader . ClasspathLoader ;  import     com . mitchellbosecke . pebble . loader . DelegatingLoader ;  import     com . mitchellbosecke . pebble . loader . FileLoader ;  import     com . mitchellbosecke . pebble . loader . Loader ;  import     com . mitchellbosecke . pebble . node . RootNode ;  import     com . mitchellbosecke . pebble . parser . Parser ;  import     com . mitchellbosecke . pebble . parser . ParserImpl ;  import     com . mitchellbosecke . pebble . template . PebbleTemplate ;  import     com . mitchellbosecke . pebble . template . PebbleTemplateImpl ;  import   java . io . Reader ;  import   java . util . ArrayList ;  import   java . util . Collection ;  import   java . util . List ;  import   java . util . Locale ;  import    java . util . concurrent . ExecutorService ;  import static    java . util . Objects . isNull ;   public class PebbleEngine  {   private final  Loader  <  ? >  loader ;   private final Syntax  syntax ;   private final boolean  strictVariables ;   private final Locale  defaultLocale ;   private final  Cache  < CacheKey , Object >  tagCache ;   private final ExecutorService  executorService ;   private final  Cache  < Object , PebbleTemplate >  templateCache ;   private final ExtensionRegistry  extensionRegistry ;   public PebbleTemplate getTemplate  (   final String templateName )  {  if  (  templateName == null )  {  return null ; }  if  (   this . loader == null )  {  throw  new LoaderException  ( null , "Loader has not yet been specified." ) ; }   final PebbleEngine  self = this ;  PebbleTemplate  result ;   final Object  cacheKey =   this . loader . createCacheKey  ( templateName ) ;  if  (  isNull  (  this . templateCache ) )  {   result =  this . getPebbleTemplate  ( self , templateName , cacheKey ) ; } else  {   result =   this . templateCache . get  ( cacheKey ,  k ->  this . getPebbleTemplate  ( self , templateName , cacheKey ) ) ; }  return result ; }   private PebbleTemplate getPebbleTemplate  (   final PebbleEngine self ,   final String templateName ,   final Object cacheKey )  throws LoaderException , ParserException  {  LexerImpl  lexer =  new LexerImpl  (  this . syntax ,    this . extensionRegistry . getUnaryOperators  ( ) . values  ( ) ,    this . extensionRegistry . getBinaryOperators  ( ) . values  ( ) ) ;  Reader  templateReader =  self . retrieveReaderFromLoader  (  self . loader , cacheKey ) ;  TokenStream  tokenStream =  lexer . tokenize  ( templateReader , templateName ) ;  Parser  parser =  new ParserImpl  (   this . extensionRegistry . getUnaryOperators  ( ) ,   this . extensionRegistry . getBinaryOperators  ( ) ,   this . extensionRegistry . getTokenParsers  ( ) ) ;  RootNode  root =  parser . parse  ( tokenStream ) ;  PebbleTemplateImpl  instance =  new PebbleTemplateImpl  ( self , root , templateName ) ;  for ( NodeVisitorFactory visitorFactory :   this . extensionRegistry . getNodeVisitors  ( ) )  {    visitorFactory . createVisitor  ( instance ) . visit  ( root ) ; }  return instance ; }   private  <  T > Reader retrieveReaderFromLoader  (   Loader  < T > loader ,  Object cacheKey )  {    @ SuppressWarnings  ( "unchecked" ) T  casted =  ( T ) cacheKey ;  return  loader . getReader  ( casted ) ; }   public  Loader  <  ? > getLoader  ( )  {  return  this . loader ; }   public  Cache  < Object , PebbleTemplate > getTemplateCache  ( )  {  return  this . templateCache ; }   public boolean isStrictVariables  ( )  {  return  this . strictVariables ; }   public Locale getDefaultLocale  ( )  {  return  this . defaultLocale ; }   public ExecutorService getExecutorService  ( )  {  return  this . executorService ; }   public Syntax getSyntax  ( )  {  return  this . syntax ; }   public ExtensionRegistry getExtensionRegistry  ( )  {  return  this . extensionRegistry ; }   public  Cache  < CacheKey , Object > getTagCache  ( )  {  return  this . tagCache ; }   public static class Builder  {   private  Loader  <  ? >  loader ;   private  List  < Extension >  userProvidedExtensions =  new  ArrayList  < >  ( ) ;   private Syntax  syntax ;   private boolean  strictVariables = false ;   private boolean  enableNewLineTrimming = true ;   private Locale  defaultLocale ;   private ExecutorService  executorService ;   private  Cache  < Object , PebbleTemplate >  templateCache ;   private boolean  cacheActive = true ;   private  Cache  < CacheKey , Object >  tagCache ;   private EscaperExtension  escaperExtension =  new EscaperExtension  ( ) ;   public Builder  ( )  { }   public Builder loader  (   Loader  <  ? > loader )  {    this . loader = loader ;  return this ; }   public Builder extension  (  Extension ...  extensions )  {  for ( Extension extension : extensions )  {    this . userProvidedExtensions . add  ( extension ) ; }  return this ; }   public Builder syntax  (  Syntax syntax )  {    this . syntax = syntax ;  return this ; }   public Builder strictVariables  (  boolean strictVariables )  {    this . strictVariables = strictVariables ;  return this ; }   public Builder newLineTrimming  (  boolean enableNewLineTrimming )  {    this . enableNewLineTrimming = enableNewLineTrimming ;  return this ; }   public Builder defaultLocale  (  Locale defaultLocale )  {    this . defaultLocale = defaultLocale ;  return this ; }   public Builder executorService  (  ExecutorService executorService )  {    this . executorService = executorService ;  return this ; }   public Builder templateCache  (   Cache  < Object , PebbleTemplate > templateCache )  {    this . templateCache = templateCache ;  return this ; }   public Builder tagCache  (   Cache  < CacheKey , Object > tagCache )  {    this . tagCache = tagCache ;  return this ; }   public Builder autoEscaping  (  boolean autoEscaping )  {    this . escaperExtension . setAutoEscaping  ( autoEscaping ) ;  return this ; }   public Builder defaultEscapingStrategy  (  String strategy )  {    this . escaperExtension . setDefaultStrategy  ( strategy ) ;  return this ; }   public Builder addEscapingStrategy  (  String name ,  EscapingStrategy strategy )  {    this . escaperExtension . addEscapingStrategy  ( name , strategy ) ;  return this ; }   public Builder cacheActive  (  boolean cacheActive )  {    this . cacheActive = cacheActive ;  return this ; }   public PebbleEngine build  ( )  {   List  < Extension >  extensions =  new  ArrayList  < >  ( ) ;   extensions . add  (  new CoreExtension  ( ) ) ;   extensions . add  (  this . escaperExtension ) ;   extensions . add  (  new I18nExtension  ( ) ) ;   extensions . addAll  (  this . userProvidedExtensions ) ;   extensions . add  (  new AttributeResolverExtension  ( ) ) ;  if  (   this . loader == null )  {   List  <  Loader  <  ? > >  defaultLoadingStrategies =  new  ArrayList  < >  ( ) ;   defaultLoadingStrategies . add  (  new ClasspathLoader  ( ) ) ;   defaultLoadingStrategies . add  (  new FileLoader  ( ) ) ;    this . loader =  new DelegatingLoader  ( defaultLoadingStrategies ) ; }  if  (   this . defaultLocale == null )  {    this . defaultLocale =  Locale . getDefault  ( ) ; }  if  (  this . cacheActive )  {  if  (   this . templateCache == null )  {    this . templateCache =    Caffeine . newBuilder  ( ) . maximumSize  ( 200 ) . build  ( ) ; }  if  (   this . tagCache == null )  {    this . tagCache =    Caffeine . newBuilder  ( ) . maximumSize  ( 200 ) . build  ( ) ; } } else  {    this . templateCache = null ;    this . tagCache = null ; }  if  (   this . syntax == null )  {    this . syntax =    new  Syntax . Builder  ( ) . setEnableNewLineTrimming  (  this . enableNewLineTrimming ) . build  ( ) ; }  return  new PebbleEngine  (  this . loader ,  this . syntax ,  this . strictVariables ,  this . defaultLocale ,  this . tagCache ,  this . templateCache ,  this . executorService , extensions , allowGetClass ) ; }   private boolean  allowGetClass = true ;   public Builder allowGetClass  (  boolean allowGetClass )  {    this . allowGetClass = allowGetClass ;  return this ; } }   private final boolean  allowGetClass ;   private PebbleEngine  (   Loader  <  ? > loader ,  Syntax syntax ,  boolean strictVariables ,  Locale defaultLocale ,   Cache  < CacheKey , Object > tagCache ,   Cache  < Object , PebbleTemplate > templateCache ,  ExecutorService executorService ,   Collection  <  ? extends Extension > extensions ,  boolean allowGetClass )  {    this . loader = loader ;    this . syntax = syntax ;    this . strictVariables = strictVariables ;    this . defaultLocale = defaultLocale ;    this . tagCache = tagCache ;    this . executorService = executorService ;    this . templateCache = templateCache ;    this . extensionRegistry =  new ExtensionRegistry  ( extensions ) ;    this . allowGetClass = allowGetClass ; }   public boolean isAllowGetClass  ( )  {  return  this . allowGetClass ; } }